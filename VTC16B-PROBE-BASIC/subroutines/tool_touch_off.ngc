o<tool_touch_off> sub

  (uses NGCGUI style arg spec)
  (number after "=" in comment is default value)
  #<probe_tool_number> = #3014
  #<probe_slow_fr> = #3015
  #<probe_fast_fr> = #3016
  #<traverse_fr> = #3017
  #<max_z_distance> = #3020
  #<max_xy_distance> = #3018
  #<xy_clearance> = #3019
  #<z_clearance> = #3021
  #<retract_distance> = #3022
  #<spindle_zero_height> = #3023
  #<tool_diameter_probe_mode> = #3024
  #<tool_diameter_offset_mode> = #3025
  #<tool_diameter> = #5410

  (PRINT, DEBUG - Values: slow_fr=#<probe_slow_fr> fast_fr=#<probe_fast_fr> traverse_fr=#<traverse_fr>)
  
  (Set default values if not provided)
  o90 if [#<probe_slow_fr> EQ 0]
    #<probe_slow_fr> = 1.0
  o90 endif
  
  o91 if [#<probe_fast_fr> EQ 0]
    #<probe_fast_fr> = 5.0
  o91 endif
  
  o92 if [#<traverse_fr> EQ 0]
    #<traverse_fr> = 10.0
  o92 endif
  
  (Mazak-style toolsetter parameters)
  #<tool_touch_x_coords> = #5181
  #<tool_touch_y_coords> = #5182
  #<tool_touch_z_coords> = #5183
  #<toolsetter_decel_distance> = 0.15748
  #<toolsetter_tolerance> = 0.07874
  
  o100 if [EXISTS[#<_ini[probe]toolsetter_decel_distance>]]
    #<toolsetter_decel_distance> = #<_ini[probe]toolsetter_decel_distance>
  o100 endif
  
  o110 if [EXISTS[#<_ini[probe]toolsetter_tolerance>]]
    #<toolsetter_tolerance> = #<_ini[probe]toolsetter_tolerance>
  o110 endif

  (Cancel G92 offsets)
  G92.1

  (Cancel Feedrate Override)
  M50 P0

  (Force consistent modes)
  G40 (Cancel tool diameter compensation)
  G49 (Cancel tool length compensation)
  G80 (Cancel canned cycles)
  G90 (Absolute distance mode)
  G21 (Metric mode - if your machine uses metric)

  (PRINT, Tool touch off sequence starting)
  
  (FIRST: Move Z to safe height to avoid collisions)
  G53 G0 Z0    (move to machine Z0 position - RAPID)
  
  (THEN: Move to X,Y position above toolsetter - RAPID)
  G53 G0 X#<tool_touch_x_coords> Y#<tool_touch_y_coords>
  
  (Current Z Position including offsets in current program units)
  #<start_z_pos> = #5422

  (PRINT, Moving to toolsetter position and beginning measurement)

  (Check if measurement sensor is already triggered before starting)
  M66 P8 L0  (Read X09 toolsetter-measure input)
  o115 if [#5399 EQ 1]
    (PRINT, Error: Measure sensor already triggered, aborting)
    G53 G0 Z0  (Return to Z home with rapid)
    M50 P1
    o<tool_touch_off> return [1]
  o115 endif

  (Check decel sensor status first)
  M66 P7 L0  (Read X08 toolsetter-decel input)
  o120 if [#5399 EQ 1]
    (PRINT, Warning: Decel sensor already activated, check tool length)
    G90 G0 Z[#<start_z_pos> + 0.5]  (Move UP to clear)
    M50 P1
    o<tool_touch_off> return [1]
  o120 endif
  
  (MAZAK APPROACH - TWO-STAGE PROBING WITH CORRECT DIRECTION)
  (First stage: find decel sensor with fast speed, monitoring with M66)
  
  G91 (Set incremental mode)
  
  (Step with explicit moves while checking decel sensor)
  #<decel_found> = 0
  #<current_depth> = 0
  
  o200 while [#<current_depth> LT #<max_z_distance> AND #<decel_found> EQ 0]
    G1 Z-0.1 F#<probe_fast_fr>  (Move DOWN 0.1 units - NEGATIVE for DOWN)
    #<current_depth> = [#<current_depth> + 0.1]
    
    M66 P7 L0  (Check decel sensor)
    o210 if [#5399 EQ 1]
      #<decel_found> = 1
      #<decel_z> = #5063
      (PRINT, Decel sensor activated at depth=#<current_depth>)
    o210 endif
  o200 endwhile
  
  o220 if [#<decel_found> EQ 0]
    (PRINT, Failed to detect decel sensor, aborting)
    G90 G0 Z#<start_z_pos>  (Return to start Z position)
    M50 P1
    o<tool_touch_off> return [1]
  o220 endif
  
  (SECOND STAGE - PRECISION MEASUREMENT)
  G38.2 Z-[#<toolsetter_decel_distance> * 1.5] F#<probe_slow_fr>  (NEGATIVE for DOWN)
  
  o230 if [#5070 EQ 0]
    (PRINT, Precision probe failed to touch off)
    G90 G0 Z#<start_z_pos>  (Return to start Z position)
    M50 P1
    o<tool_touch_off> return [1]
  o230 endif
  
  (Record the position when measure sensor activated)
  #<z_minus_probed> = #5063
  (PRINT, Measure sensor activated at Z=#<z_minus_probed>)
  
  (Retract from the touch point)
  G90 G0 Z[#<z_minus_probed> + #<z_clearance>]  (Move UP by clearance)

  (Calculate tool length)
  #<tool_length> = [#<spindle_zero_height> - #<z_minus_probed>]
  
  (PRINT, Tool length: #<tool_length>)
  
  (Set tool table entry)
  G10 L1 P#<_current_tool> Z[#<tool_length>]
  
  G43 (use tool length compensation)
  
  (Move to safe height for ATC)
  o250 if [EXISTS[#<_ini[atc]z_tool_change_height>]]
    G90 G53 G0 Z[#<_ini[atc]z_tool_change_height>]
  o250 else
    G90 G53 G0 Z0  (Move to Z0)
  o250 endif

  (Reinstate Feedrate Override)
  M50 P1

o<tool_touch_off> endsub [1]

M2