o<tool_touch_off> sub

  (uses NGCGUI style arg spec)
  (number after "=" in comment is default value)
  #<probe_tool_number> = #3014
  #<probe_slow_fr> = #3015
  #<probe_fast_fr> = #3016
  #<traverse_fr> = #3017
  #<max_z_distance> = #3020
  #<max_xy_distance> = #3018
  #<xy_clearance> = #3019
  #<z_clearance> = #3021
  #<retract_distance> = #3022
  #<spindle_zero_height> = #3023
  #<tool_diameter_probe_mode> = #3024
  #<tool_diameter_offset_mode> = #3025
  #<tool_diameter> = #5410
  
  (Mazak-style toolsetter parameters)
  #<tool_touch_x_coords> = #5181
  #<tool_touch_y_coords> = #5182
  #<tool_touch_z_coords> = #5183
  #<toolsetter_decel_distance> = 0.15748
  #<toolsetter_tolerance> = 0.07874
  
  o100 if [EXISTS[#<_ini[probe]toolsetter_decel_distance>]]
    #<toolsetter_decel_distance> = #<_ini[probe]toolsetter_decel_distance>
  o100 endif
  
  o110 if [EXISTS[#<_ini[probe]toolsetter_tolerance>]]
    #<toolsetter_tolerance> = #<_ini[probe]toolsetter_tolerance>
  o110 endif

  (Cancel G92 offsets)
  G92.1

  (Cancel Feedrate Override)
  M50 P0

  G49

  G90    (set absolute coordinates)
  G53 G1 F[#<traverse_fr>] Z0    (move to z0 home position)
  G53 G1 F[#<traverse_fr>] X#<tool_touch_x_coords> Y#<tool_touch_y_coords>
  
  (Current Z Position including offsets in current program units)
  #<z> = #5422

  (PRINT, Moving to toolsetter position and beginning measurement)

  (Initial Fast Z- Probe until decel sensor activates)
  G91
  F[#<probe_fast_fr>]
  
  (Check decel sensor status first)
  M66 P8 L0   (Read X08 toolsetter-decel input)
  o115 if [#5399 EQ 1]
    (PRINT, Warning: Decel sensor already activated, check tool length)
    G90
    G1 F[#<traverse_fr>] Z[#<z> + 0.5]
  o115 endif
  
  (Move down until decel sensor activates)
  M66 P8 L3 Q[#<max_z_distance>]  (Wait for decel sensor with timeout)
  #<decel_sensor_status> = #5399
  
  o120 if [#<decel_sensor_status> LT 0]
    (PRINT, Failed to detect decel sensor, aborting)
    G90
    G1 F[#<traverse_fr>] Z#<z>
    F[#<probe_fast_fr>]
    M50 P1
    o<tool_touch_off> return
  o120 endif
  
  (PRINT, Decel sensor activated, continuing at slow speed)
  
  (Record decel sensor position)
  #<decel_triggered_pos> = #5063
  
  (Switch to slow feed rate and continue)
  F[#<probe_slow_fr>]
  
  (Move down until measure sensor activates)
  M66 P9 L3 Q[#<toolsetter_decel_distance> * 2]  (Wait for measure sensor with timeout)
  #<measure_sensor_status> = #5399
  
  o130 if [#<measure_sensor_status> LT 0]
    (PRINT, Failed to detect measure sensor, aborting)
    G90
    G1 F[#<traverse_fr>] Z#<z>
    F[#<probe_fast_fr>]
    M50 P1
    o<tool_touch_off> return
  o130 endif
  
  (Record the position when measure sensor activated)
  #<z_minus_probed> = #5063
  
  (Move to z_clearance height for confirmation probe)
  G90
  G1 F[#<traverse_fr>] Z[#<z_minus_probed> + #<z_clearance>]

  (Confirmation probe at slow speed)
  G91
  F[#<probe_slow_fr>]
  
  (Move down until measure sensor activates again)
  M66 P9 L3 Q[#<z_clearance> * 2]  (Wait for measure sensor with timeout)
  
  o140 if [#5399 LT 0]
    (PRINT, Failed confirmation probe, using initial measurement)
  o140 else
    #<z_minus_confirmed> = #5063
    #<measure_diff> = [ABS[#<z_minus_probed> - #<z_minus_confirmed>]]
    
    o145 if [#<measure_diff> GT #<toolsetter_tolerance>]
      (PRINT, Warning: Confirmation measurement differs by #<measure_diff>)
    o145 else
      #<z_minus_probed> = #<z_minus_confirmed>
      (PRINT, Confirmation measurement successful)
    o145 endif
  o140 endif

  (Calculate tool length)
  #<tool_length> = [#<spindle_zero_height> - #<z_minus_probed>]
  
  (PRINT, Tool length: #<tool_length>)
  
  (Set tool table entry)
  G10 L1 P#<_current_tool> Z[#<tool_length>]
  
  G43 (use tool length compensation)
  
  (Move to safe height for ATC)
  o150 if [EXISTS[#<_ini[atc]z_tool_change_height>]]
    G90
    G53 G1 F[#<traverse_fr>] Z[#<_ini[atc]z_tool_change_height>]
  o150 else
    G90
    G53 G1 F[#<traverse_fr>] Z0
  o150 endif

  (Reinstate Feedrate Override)
  M50 P1

o<tool_touch_off> endsub [1]

M2