o<tool_touch_off> sub
  (author: Chris P & AI Assistant)
  (version: 1.5)
  (date: 04/15/25)
  (description: Tool length measurement using two-stage probing for Mazak-style toolsetters)

  (PRINT, TOOL_TOUCH_OFF: Starting tool length measurement routine)
  
  ; Get probe parameters directly from system variables
  ; This ensures we always get the current values set by tool_setter_param_update.ngc
  #<probe_slow_fr> = #3015
  #<probe_fast_fr> = #3016
  #<traverse_fr> = #3017
  #<max_z_distance> = #3020
  #<z_clearance> = #3021
  #<spindle_zero_height> = #3023
  #<current_tool> = #5400  ; Get current tool number

  ; Display current parameters for debugging
  (PRINT, Current tool: #<current_tool>)
  (PRINT, Current parameters: Slow=#<probe_slow_fr> Fast=#<probe_fast_fr> Traverse=#<traverse_fr>)
  (PRINT, Spindle zero height: #<spindle_zero_height>)
  
  ; Basic validation to ensure we have non-zero feed rates
  ; Same approach as toolsetter_wco.ngc
  o90 if [#<probe_slow_fr> LE 0]
    #<probe_slow_fr> = 5.0  ; Default slow feed rate for imperial units
    (PRINT, WARNING: Resetting probe_slow_fr to #<probe_slow_fr>)
  o90 endif
  
  o91 if [#<probe_fast_fr> LE 0]
    #<probe_fast_fr> = 10.0  ; Default fast feed rate for imperial units
    (PRINT, WARNING: Resetting probe_fast_fr to #<probe_fast_fr>)
  o91 endif
  
  o92 if [#<traverse_fr> LE 0]
    #<traverse_fr> = 20.0  ; Default traverse feed rate for imperial units
    (PRINT, WARNING: Resetting traverse_fr to #<traverse_fr>)
  o92 endif
  
  o93 if [#<max_z_distance> LE 0]
    #<max_z_distance> = 6.0  ; Default max Z travel distance (6 inches)
    (PRINT, WARNING: Resetting max_z_distance to #<max_z_distance>)
  o93 endif
  
  o94 if [#<z_clearance> LE 0]
    #<z_clearance> = 0.1  ; Default clearance distance (0.1 inches)
    (PRINT, WARNING: Resetting z_clearance to #<z_clearance>)
  o94 endif
  
  ; Toolsetter parameters - just like toolsetter_wco.ngc
  #<toolsetter_decel_distance> = 0.5  ; Distance between decel and measure sensors
  #<toolsetter_tolerance> = 0.001    ; Measurement tolerance
  
  ; Get toolsetter coordinates from G30 reference position
  #<tool_touch_x_coords> = #5181  ; G30 X position
  #<tool_touch_y_coords> = #5182  ; G30 Y position
  #<tool_touch_z_coords> = #5183  ; G30 Z position
  
  ; Verify we have valid G30 position
  o95 if [#<tool_touch_x_coords> EQ 0 OR #<tool_touch_y_coords> EQ 0]
    (PRINT, WARNING: G30 position may not be set correctly - verify toolsetter location)
  o95 endif
  
  ; Verify spindle zero height parameter  
  o97 if [#<spindle_zero_height> EQ 0]
    #<spindle_zero_height> = -4.0  ; Reasonable default for Mazak-style machine
    (PRINT, WARNING: Using default spindle zero height: #<spindle_zero_height>)
  o97 endif
  
  (PRINT, Tool touch off destination: X=#<tool_touch_x_coords> Y=#<tool_touch_y_coords>)

  ; Check if HAL pins are connected - essential for toolsetting
  M66 P7 L0  ; Try reading decel sensor
  o112 if [#5399 EQ -1]
    (PRINT, ERROR: Decel sensor P7 not connected in HAL)
    o<tool_touch_off> return [1]
  o112 endif
   
  M66 P8 L0  ; Try reading measure sensor
  o114 if [#5399 EQ -1]
    (PRINT, ERROR: Measure sensor P8 not connected in HAL)
    o<tool_touch_off> return [1]
  o114 endif

  ; Prepare for probing
  G92.1       ; Cancel G92 offsets
  M50 P0      ; Cancel Feedrate Override
  G40 G49 G80 ; Cancel compensations and cycles
  G90         ; Absolute distance mode
  G20         ; Imperial mode (inches)

  (PRINT, Tool touch off sequence starting)
  
  ; Move Z to safe height for traversal
  F#<traverse_fr>
  G53 G1 Z0 F#<traverse_fr>
  
  ; Move to G30 position (toolsetter location)
  (PRINT, Moving to toolsetter position)
  G30
  
  ; Get current position after G30 move
  #<start_x_pos> = #5420
  #<start_y_pos> = #5421
  #<start_z_pos> = #5422
  (PRINT, At toolsetter: X=#<start_x_pos> Y=#<start_y_pos> Z=#<start_z_pos>)

  ; Check sensors before starting - avoid crashes
  M66 P7 L0  ; Check decel sensor
  o115 if [#5399 EQ 1]
    (PRINT, WARNING: Decel sensor already triggered before probing!)
    G90
    G53 G0 Z0  ; Return to Z home
    M50 P1
    o<tool_touch_off> return [1]
  o115 endif
   
  M66 P8 L0  ; Check measure sensor
  o116 if [#5399 EQ 1]
    (PRINT, WARNING: Measure sensor already triggered before probing!)
    G53 G0 Z0  ; Return to Z home
    M50 P1
    o<tool_touch_off> return [1]
  o116 endif
  
  (PRINT, Starting probing sequence - using fast feed rate: #<probe_fast_fr>)
  
  ; PHASE 1: Find decel sensor with fast feed rate
  G91  ; Incremental mode
  
  #<decel_found> = 0
  #<current_depth> = 0
  
  ; Set feed rate once before the loop
  F#<probe_fast_fr>
  
  ; Search for decel sensor with 0.25" steps
  o200 while [#<current_depth> LT #<max_z_distance> AND #<decel_found> EQ 0]
    G1 Z-0.25
    #<current_depth> = [#<current_depth> + 0.25]
    
    M66 P7 L0  ; Check decel sensor
    o210 if [#5399 EQ 1]
      #<decel_found> = 1
      #<decel_z> = #5063
      (PRINT, Decel sensor found at Z=#<decel_z>)
    o210 endif
    
    ; Safety check - shouldn't hit measure sensor first
    M66 P8 L0
    o212 if [#5399 EQ 1]
      (PRINT, ERROR: Measure sensor triggered before decel sensor!)
      G90
      G53 G0 Z0  ; Return to Z home
      M50 P1
      o<tool_touch_off> return [1]
    o212 endif
    
    ; Status updates during long moves
    o214 if [#<current_depth> MOD 1.0 LT 0.25]
      (PRINT, Searching at depth: #<current_depth>)
    o214 endif
  o200 endwhile
  
  o220 if [#<decel_found> EQ 0]
    (PRINT, ERROR: Failed to find decel sensor after #<current_depth> inches)
    G90
    G53 G0 Z0  ; Return to Z home
    M50 P1
    o<tool_touch_off> return [1]
  o220 endif
  
  ; PHASE 2: Find measure sensor with slow feed rate
  (PRINT, Starting precision probe for measure sensor - feed rate: #<probe_slow_fr>)
  
  ; Position to decel sensor hit location first
  G90
  G1 Z#<decel_z> F#<traverse_fr>
  
  ; Then probe down slowly to find measure sensor
  G91
  G38.2 Z-1.0 F#<probe_slow_fr>
  
  o230 if [#5070 EQ 0]
    (PRINT, ERROR: Precision probe failed to find measure sensor)
    G90
    G53 G0 Z0  ; Return to Z home
    M50 P1
    o<tool_touch_off> return [1]
  o230 endif
  
  ; Record the measure sensor position
  #<z_minus_probed> = #5063
  (PRINT, Measure sensor activated at Z=#<z_minus_probed>)
  
  ; Retract slightly from the measure sensor
  G90
  G1 Z[#<z_minus_probed> + #<z_clearance>] F#<traverse_fr>

  ; Double-check with confirmation probe
  (PRINT, Performing confirmation probe)
  G91
  G38.2 Z-[#<z_clearance> * 2] F#<probe_slow_fr>
  
  #<z_confirm_probed> = #5063
  (PRINT, Confirmation probe hit at Z=#<z_confirm_probed>)
  
  ; Check if confirmation is within tolerance
  #<probe_diff> = [ABS[#<z_minus_probed> - #<z_confirm_probed>]]
  o240 if [#<probe_diff> GT #<toolsetter_tolerance>]
    (PRINT, WARNING: Probe measurements differ by #<probe_diff> - outside tolerance #<toolsetter_tolerance>)
  o240 endif

  ; Calculate tool length
  #<tool_length> = [#<spindle_zero_height> - #<z_confirm_probed>]
  
  (PRINT, Calculated tool length: #<tool_length>)
  
  ; Update tool table with new length
  G10 L1 P#<current_tool> Z#<tool_length>
  
  ; Apply the tool length compensation
  G43 H#<current_tool>
  
  ; Retract from toolsetter
  G90
  G1 Z[#<z_confirm_probed> + 0.5] F#<traverse_fr>
  
  ; Return to safe Z height
  G53 G0 Z0
  
  ; Reinstate Feedrate Override
  M50 P1
  
  (PRINT, Tool touch off complete - Tool #<current_tool> length set to: #<tool_length>)
  (PRINT, Tool table updated with command: G10 L1 P#<current_tool> Z#<tool_length>)

o<tool_touch_off> endsub [1]

M2