o<toolsetter_wco> sub

  (uses NGCGUI style arg spec)
  (number after "=" in comment is default value)
  #<probe_tool_number> = #3014
  #<probe_slow_fr> = #3015
  #<probe_fast_fr> = #3016
  #<traverse_fr> = #3017
  #<max_z_distance> = #3020
  #<max_xy_distance> = #3018
  #<xy_clearance> = #3019
  #<z_clearance> = #3021
  #<retract_distance> = #3022
  #<spindle_zero_height> = #3023
  #<tool_diameter_probe_mode> = #3024
  #<tool_diameter_offset_mode> = #3025
  #<tool_diameter> = #5410
  #<decel_to_measure_max_distance> = 1.1  (Maximum safe distance between decel and measure in inches)
  
  (Toolsetter parameters)
  #<tool_touch_x_coords> = #5181
  #<tool_touch_y_coords> = #5182
  #<tool_setter_height> = #5183
  #<toolsetter_tolerance> = 0.07874
  
  o110 if [EXISTS[#<_ini[probe]toolsetter_tolerance>]]
    #<toolsetter_tolerance> = #<_ini[probe]toolsetter_tolerance>
  o110 endif

  o112 if [EXISTS[#<_ini[probe]decel_to_measure_max_distance>]]
    #<decel_to_measure_max_distance> = #<_ini[probe]decel_to_measure_max_distance>
  o112 endif
  
  (start with an m6, do all the standard m6 stuff and then touch off)
  M6

  (Cancel G92 offsets)
  G92.1

  (Cancel Feedrate Override)
  M50 P0

  G49 (Cancel tool length compensation)

  G90    (set absolute coordinates)
  G53 G1 F[ABS[#<traverse_fr>]] Z0    (move to z0 home position)
  G53 G1 F[ABS[#<traverse_fr>]] X#<tool_touch_x_coords> Y#<tool_touch_y_coords>
  
  #<workspace_z> = #[5203 + [20 * #5220]]

  (Current Z Position including offsets in current program units)
  #<start_z_pos> = #5422

  (PRINT, Moving to toolsetter position and beginning measurement)

  (Check if measurement sensor is already triggered before starting)
  M66 P8 L0  (Read X09 toolsetter-measure input)
  o125 if [#5399 EQ 1]
    (PRINT, Error: Measure sensor already triggered, aborting)
    G90
    G53 G1 F[ABS[#<traverse_fr>]] Z0
    M50 P1
    o<toolsetter_wco> return
  o125 endif
  
  (Check if decel sensor is already triggered)
  M66 P7 L0  (Read decel sensor input)
  o126 if [#5399 EQ 1]
    (PRINT, Error: Decel sensor already triggered, aborting)
    G90
    G53 G1 F[ABS[#<traverse_fr>]] Z0
    M50 P1
    o<toolsetter_wco> return
  o126 endif
  
  (FIRST STAGE - FIND DECEL SENSOR WITH FAST PROBE)
  G91 (Set incremental mode)
  (PRINT, Beginning fast probe to locate decel sensor)
  F[#<probe_fast_fr>]
  
  (First find the decel sensor)
  G38.3 Z-[#<max_z_distance>] (Fast probe to find decel sensor)
  
  o210 if [#5070 EQ 0]
    (PRINT, Failed to detect decel sensor, aborting)
    G90
    G1 F[#<traverse_fr>] Z#<start_z_pos>
    M50 P1
    o<toolsetter_wco> return
  o210 endif
  
  (Record decel sensor position)
  #<decel_z> = #5063
  (PRINT, Decel sensor activated at Z=#<decel_z>)
  
  (SECOND STAGE - FIND MEASURE SENSOR FROM DECEL POINT)
  (PRINT, Continuing to find measure sensor)
  F[#<probe_slow_fr>]  (Slower feed rate for precision)
  G38.2 Z-[#<decel_to_measure_max_distance>]  (Move up to max safe distance)
  
  o220 if [#5070 EQ 0]
    (PRINT, Failed to detect measure sensor within safety distance, aborting)
    G90
    G1 F[#<traverse_fr>] Z#<start_z_pos>
    M50 P1
    o<toolsetter_wco> return
  o220 endif
  
  (Record fast probe contact point)
  #<fast_probe_z> = #5063
  (PRINT, Fast probe contact at Z=#<fast_probe_z>)
  
  (VERIFY SENSORS ARE AT A REASONABLE DISTANCE APART)
  #<sensors_distance> = [ABS[#<decel_z> - #<fast_probe_z>]]
  o225 if [#<sensors_distance> GT #<decel_to_measure_max_distance>]
    (PRINT, Warning: Distance between sensors (#<sensors_distance>) exceeds maximum)
    G90
    G1 F[#<traverse_fr>] Z#<start_z_pos>
    M50 P1
    o<toolsetter_wco> return
  o225 endif
  
  (Retract by standard amount for precision measurement)
  G90
  G1 F[#<traverse_fr>] Z[#<fast_probe_z> + #<retract_distance>]
  
  (THIRD STAGE - PRECISION MEASUREMENT)
  G91 (Ensure incremental mode)
  (PRINT, Beginning precision measurement)
  F[#<probe_slow_fr>]  (Set slow feed rate)
  G38.2 Z-[#<retract_distance> * 2]  (Precision probe move)
  
  o230 if [#5070 EQ 0]
    (PRINT, Precision probe failed to touch off)
    G90
    G1 F[#<traverse_fr>] Z#<start_z_pos>
    M50 P1
    o<toolsetter_wco> return
  o230 endif
  
  (Record the position when measure sensor activated)
  #<z_minus_probed> = #5063
  (PRINT, Measure sensor activated at Z=#<z_minus_probed>)
  
  (Verify measurement is reasonable compared to fast probe)
  #<measurement_diff> = [ABS[#<fast_probe_z> - #<z_minus_probed>]]
  o235 if [#<measurement_diff> GT #<toolsetter_tolerance>]
    (PRINT, Warning: Large difference between fast and precision measurements: #<measurement_diff>)
  o235 endif
  
  (Retract from the touch point)
  G90
  G1 F[#<traverse_fr>] Z[#<start_z_pos>]

  #<new_tool_wco_z> = [#<z_minus_probed> - #<tool_setter_height>]

  (Record Z zero in selected WCO)
  G10 L2 P#5220 Z[#<new_tool_wco_z> + #<workspace_z>]
  
  (PRINT, Tool Z offset set in WCO #5220)

  (Move to safe height for ATC)
  o250 if [EXISTS[#<_ini[atc]z_tool_change_height>]]
    G90
    G53 G1 F[#<traverse_fr>] Z[#<_ini[atc]z_tool_change_height>]
  o250 else
    G90
    G53 G1 F[#<traverse_fr>] Z0
  o250 endif

  (Reinstate Feedrate Override)
  M50 P1

o<toolsetter_wco> endsub [1]

M2