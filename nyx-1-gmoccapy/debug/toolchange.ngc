o<toolchange> sub

M70

M09

#<atc_safe_feed> = 3000
#<atc_safe_x> = -150
#<atc_safe_z> = 0
#<atc_pocket_x> = 55.928
#<atc_pocket_y> = -194.375
#<atc_pocket_z> = -132.000

G00 G90 G53 G21 Z#<atc_safe_z> ;raise z
G00 G90 G53 G21 X#<atc_safe_x> Y#<atc_pocket_y> ;move xy to approach position

o109 if [#<t> EQ #<_current_tool>]
	(MSG, TOOL ALREADY IN SPINDLE!)
	M2
o109 endif
;o110 if [#<t> EQ 5]
;	(ABORT, POCKET DAMAGED!)
;o110 endif
;o111 if [#<t> EQ 10]
;	(ABORT, POCKET DAMAGED!)
;o111 endif
;o112 if [#<t> EQ 11]
;	(ABORT, POCKET DAMAGED!)
;o112 endif
;o113 if [#<t> EQ 15]
;	(ABORT, POCKET DAMAGED!)
;o113 endif
;o114 if [#<t> EQ 18]
;	(ABORT, POCKET DAMAGED!)
;o114 endif
;o115 if [#<t> EQ 19]
;	(ABORT, POCKET DAMAGED!)
;o115 endif
;o116 if [#<t> EQ 20]
;	(ABORT, POCKET DAMAGED!)
;o116 endif
;o117 if [#<t> EQ 21]
;	(ABORT, POCKET DAMAGED!)
;o117 endif
;o118 if [#<t> EQ 24]
;	(ABORT, POCKET DAMAGED!)
;o118 endif

M18 ;orient spindle

M23 ;carousel extend

;select pocket of tool in spindle
o101 if [#<_current_tool> GT 0]
	M68 E0 Q#<_current_tool> ;current tool
	M65 P6 ;brake off
	G4 P.001 ;dwell
	M64 P7 ;start carousel
	G4 P.001 ;dwell
	M66 P16 L3 Q60 ; wait for carousel finished
	
	o102 if [#5399 LT 0]
		(ABORT, FAILED TO ALIGN CAROUSEL!)
	o102 endif
	
	G4 P.001 ;dwell
	M64 P6 ;brake on
	G4 P.1 ;dwell
	M65 P6 ;brake off
	M65 P7 ;stop carousel
	;store tool
	G00 G90 G53 G21 X#<atc_safe_x> Y#<atc_pocket_y> ;move xy to approach position
	G00 G90 G53 G21 Z#<atc_pocket_z> ;lower
	G01 G90 G53 G21 F#<atc_safe_feed> X#<atc_pocket_x> ;move x into pocket
	M21 ;drawbar unclamp
	G01 G90 G53 G21 F#<atc_safe_feed> Z#<atc_safe_z> ;raise z
o101 endif

o103 if [#<t> GT 0]
	;select pocket of requested tool
	M68 E0 Q#<t> ;requested tool
	M65 P6 ;brake off
	G4 P.001 ;dwell
	M64 P7 ;start carousel
	G4 P.001 ;dwell
	M66 P16 L3 Q60 ; wait for carousel finished
	
	o104 if [#5399 LT 0]
		(ABORT, FAILED TO ALIGN CAROUSEL!)
	o104 endif
	
	G4 P.001 ;dwell
	M64 P6 ;brake on
	G4 P.1 ;dwell
	M65 P6 ;brake off
	M65 P7 ;stop carousel

	;remove tool
	G01 G90 G53 G21 F#<atc_safe_feed> X#<atc_pocket_x> Y#<atc_pocket_y> ;move above pocket
	M21 ;drawbar unclamp
	G01 G90 G53 G21 F#<atc_safe_feed> Z#<atc_pocket_z> ;lower z
	M22 ;drawbar clamp
	G01 G90 G53 G21 F#<atc_safe_feed> X#<atc_safe_x> ;move x to retract position
	G00 G53 G21 Z#<atc_safe_z> ;raise z
o103 endif

o106 if [#<t> EQ 0]
	M22 ;drawbar clamp
o106 endif

M24 ;carousel retract

M72

G20

o<toolchange> endsub [1]
M2
